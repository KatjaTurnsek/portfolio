{"version":3,"file":"index.js","sources":["../src/context.ts","../src/partials.ts","../src/index.ts"],"sourcesContent":["import os from 'os';\nimport path from 'path';\n\nexport type Context =\n  | Record<string, unknown>\n  | ((path: string) => Record<string, unknown>)\n  | ((path: string) => Promise<Record<string, unknown>>);\n\nexport async function resolveContext(\n  context: Context | undefined,\n  pagePath: string\n): Promise<Record<string, unknown> | undefined> {\n  if (typeof context === 'undefined') {\n    return context;\n  }\n\n  if (typeof context === 'function') {\n    return resolveContext(await context(pagePath), pagePath);\n  }\n\n  const output: Record<string, unknown> = {};\n\n  for (const key of Object.keys(context)) {\n    const value = context[key];\n\n    if (typeof value === 'function') {\n      output[key] = await value(pagePath);\n    } else {\n      output[key] = value;\n    }\n  }\n\n  return output;\n}\n\nconst isWindows = os.platform() === 'win32';\nexport function normalizePath(id: string): string {\n  return path.posix.normalize(isWindows ? id.replace(/\\\\/g, '/') : id);\n}\n","import { registerPartial } from 'handlebars';\nimport { opendir, readFile } from 'fs/promises';\nimport { join, parse } from 'path';\n\nconst VALID_EXTENSIONS = new Set(['.html', '.hbs']);\n\n// Borrowed from https://gist.github.com/lovasoa/8691344\nasync function* walk(dir: string): AsyncGenerator<string> {\n  for await (const d of await opendir(dir)) {\n    const fullFileName = join(dir, d.name);\n\n    if (d.isDirectory()) {\n      yield* walk(fullFileName);\n    } else if (d.isFile()) {\n      yield fullFileName;\n    }\n  }\n}\n\n/**\n * Registers each HTML file in a directory as Handlebars partial\n */\nexport async function registerPartials(\n  directoryPath: string | Array<string>,\n  partialsSet: Set<string>\n): Promise<void> {\n  const pathArray: Array<string> = Array.isArray(directoryPath) ? directoryPath : [directoryPath];\n\n  for await (const path of pathArray) {\n    try {\n      for await (const fileName of walk(path)) {\n        const parsedPath = parse(fileName);\n\n        if (VALID_EXTENSIONS.has(parsedPath.ext)) {\n          const partialName = join(parsedPath.dir, parsedPath.name).replace(`${path}/`, '');\n          const content = await readFile(fileName);\n\n          partialsSet.add(fileName);\n\n          registerPartial(partialName, content.toString());\n        }\n      }\n    } catch (e) {\n      // This error indicates the partial directory doesn't exist; ignore it\n      if (e.code !== 'ENOENT') {\n        throw e;\n      }\n    }\n  }\n}\n","import { compile, registerHelper, RuntimeOptions } from 'handlebars';\nimport { resolve } from 'path';\nimport { IndexHtmlTransformContext, Plugin as VitePlugin } from 'vite';\nimport { Context, resolveContext, normalizePath } from './context';\nimport { registerPartials } from './partials';\n\ntype CompileArguments = Parameters<typeof compile>;\ntype CompileOptions = CompileArguments[1];\n\nexport interface HandlebarsPluginConfig {\n  context?: Context;\n  reloadOnPartialChange?: boolean;\n  compileOptions?: CompileOptions;\n  runtimeOptions?: RuntimeOptions;\n  partialDirectory?: string | Array<string>;\n}\n\nexport default function handlebars({\n  context,\n  reloadOnPartialChange = true,\n  compileOptions,\n  runtimeOptions,\n  partialDirectory,\n}: HandlebarsPluginConfig = {}): VitePlugin {\n  // Keep track of what partials are registered\n  const partialsSet = new Set<string>();\n\n  let root: string;\n\n  registerHelper('resolve-from-root', function (path) {\n    return resolve(root, path);\n  });\n\n  return {\n    name: 'handlebars',\n\n    configResolved(config) {\n      root = config.root;\n    },\n\n    async handleHotUpdate({ server, file }) {\n      if (reloadOnPartialChange && partialsSet.has(file)) {\n        server.ws.send({\n          type: 'full-reload',\n        });\n\n        return [];\n      }\n    },\n\n    transformIndexHtml: {\n      // Ensure Handlebars runs _before_ any bundling\n      enforce: 'pre',\n\n      async transform(html: string, ctx: IndexHtmlTransformContext): Promise<string> {\n        if (partialDirectory) {\n          await registerPartials(partialDirectory, partialsSet);\n        }\n\n        const template = compile(html, compileOptions);\n\n        const resolvedContext = await resolveContext(context, normalizePath(ctx.path));\n        const result = template(resolvedContext, runtimeOptions);\n\n        return result;\n      },\n    },\n  };\n}\n"],"names":["resolveContext","context","pagePath","output","key","Object","keys","value","isWindows","os","platform","normalizePath","id","path","posix","normalize","replace","VALID_EXTENSIONS","Set","walk","dir","opendir","d","fullFileName","join","name","isDirectory","isFile","registerPartials","directoryPath","partialsSet","pathArray","Array","isArray","fileName","parsedPath","parse","has","ext","partialName","content","readFile","add","registerPartial","toString","e","code","handlebars","reloadOnPartialChange","compileOptions","runtimeOptions","partialDirectory","root","registerHelper","resolve","configResolved","config","handleHotUpdate","server","file","ws","send","type","transformIndexHtml","enforce","transform","html","ctx","template","compile","resolvedContext","result"],"mappings":"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"}